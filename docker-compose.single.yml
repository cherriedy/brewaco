# Alternative Docker Compose Configuration - Single Container for Both Servers
# This configuration runs both Express.js servers in a single container

services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: brewaco-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-brewaco}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - brewaco-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MeiliSearch
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: brewaco-meilisearch
    restart: unless-stopped
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_ENV=production
      - MEILI_NO_ANALYTICS=true
    ports:
      - "7700:7700"
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - brewaco-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:7700/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dual Express.js Servers (Public + Admin in one container)
  brewaco-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: brewaco:latest
    container_name: brewaco-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PUBLIC_PORT=9001
      - PROTECTED_PORT=9002
      - MONGODB_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/${MONGO_INITDB_DATABASE:-brewaco}?authSource=admin
      - JWT_SECRET=${JWT_SECRET}
      - MAILERSEND_API_KEY=${MAILERSEND_API_KEY}
      - MAILERSEND_FROM_EMAIL=${MAILERSEND_FROM_EMAIL}
      - MAILERSEND_FROM_NAME=${MAILERSEND_FROM_NAME}
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_INDEX_PRODUCTS=products
    ports:
      - "9001:9001" # Public API
      - "9002:9002" # Admin API
    depends_on:
      mongodb:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    networks:
      - brewaco-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http = require('http'); const check = (port) => new Promise((resolve, reject) => { http.get('http://localhost:' + port, (res) => { res.statusCode === 200 ? resolve() : reject(); }).on('error', reject); }); Promise.all([check(9001), check(9002)]).then(() => process.exit(0)).catch(() => process.exit(1));",
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: brewaco-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.docker.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - brewaco-api
    networks:
      - brewaco-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  brewaco-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  meilisearch_data:
    driver: local
  nginx_logs:
    driver: local
